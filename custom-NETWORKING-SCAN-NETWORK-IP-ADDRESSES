#!/bin/bash

#
# Script: Scan Network IP Addresses
# Description: This script scans a local network for connected devices.
#              It prompts the user to select a network interface, then uses
#              nmap, netdiscover, and nbtscan to discover and list IP addresses,
# Dependencies: nmap, netdiscover, whiptail
#

# --- Dependency Check ---
# Ensure all required packages are installed before proceeding.
for PACKAGE in nmap netdiscover whiptail; do
	if ! dpkg -s $PACKAGE >/dev/null 2>&1; then
		echo "Dependency $PACKAGE is not installed. Installing..."
		sudo apt update
		sudo apt install -y $PACKAGE
		# Verify installation and exit if it failed.
		if ! dpkg -s $PACKAGE >/dev/null 2>&1; then
			echo "Failed to install dependency $PACKAGE. Exiting..."
			exit 1
		fi
	fi
done

# this script requieres to be run as root or with sudo
if [ "$EUID" -ne 0 ]; then
	echo -e "\e[0;45m  this script requieres to be run as root or with sudo  \e[0m"
	echo -e "\e[0;45m  Please run as root or with sudo.  \e[0m"
	sudo "$0"
fi
# recheck if the script is running as root
if [ "$EUID" -ne 0 ]; then
	echo "Failed to run as root. Exiting."
	exit 1
fi

FUN_NETWORKING_SCAN_NETWORK() {

	# clear screen for better readability
	clear

	# --- Network Interface Selection ---
	# Fetch available network interfaces and present them to the user.
	__AVAILABLE_NETIFACE=$(ip addr show |
		grep '^[0-9]' | # Filter for lines starting with a number (indicating an interface)
		cut -d: -f2 |   # Extract the interface name
		nl |            # Add line numbers for the menu
		tr -d ' ')      # Remove extra spaces

	# Count the number of available interfaces for the menu.
	__AVAILABLE_NETIFACE_COUNT=$(echo "$__AVAILABLE_NETIFACE" | wc -l)

	# Display a menu for the user to select an interface.
	__CHOICE_NETIFACE=$(whiptail --backtitle "SCAN NETWORK IP ADDRESSES" --title "Select Network Interface" \
		--menu "Choose an interface to scan:" 0 0 $__AVAILABLE_NETIFACE_COUNT \
		$__AVAILABLE_NETIFACE 3>&1 1>&2 2>&3)

	# Exit if the user cancels the selection.
	if [ -z "$__CHOICE_NETIFACE" ]; then
		echo "Operation aborted by the user. Exiting..."
		exit
	fi

	# trap for CTRL+C
	trap 'echo -e "\n Interrupted! Exiting..."; exit 1' INT

	# --- IP Address and Range Extraction ---
	# Get the name of the selected interface.
	__SELECTED_NETIFACE_FINAL=$(echo "$__AVAILABLE_NETIFACE" |
		grep -w "^$__CHOICE_NETIFACE" | # Find the chosen interface by its number
		sed "s/$__CHOICE_NETIFACE//1" | # Remove the number prefix
		tr -d '[:space:]')              # Trim whitespace

	# Extract the IP address and subnet (CIDR notation) for the selected interface.
	__NETIFACE_IPADDR_SCAN_RANGE=$(ip addr show "$__SELECTED_NETIFACE_FINAL" |
		grep -w "inet" |  # Filter for the line containing the IPv4 address
		awk '{print $2}') # Extract the second field (the IP address with CIDR)

	# Remove the CIDR notation (e.g., /24) to get the clean IP address.
	__SANITIZED_IP_ADDR_SCAN_RANGE=$(echo "$__NETIFACE_IPADDR_SCAN_RANGE" | sed 's+/[0-9]*++g')

	# --- Network Scanning ---
	echo "><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><"
	echo "Scanning network range: $__NETIFACE_IPADDR_SCAN_RANGE  This may take a moment..."
	__SELECTED_NETIFACE_FINAL_IP=${__NETIFACE_IPADDR_SCAN_RANGE//\/[0-9]*/ }
	echo YOUR NETIFACE IP: "[$__SELECTED_NETIFACE_FINAL] $__SELECTED_NETIFACE_FINAL_IP"

	# Create temporary files for scanner outputs
	TMP_NMAP=$(mktemp)
	TMP_NETDISCOVER=$(mktemp)
	TMP_NBTSCAN=$(mktemp)

	# Ensure temp files are cleaned up on exit
	trap 'rm -f "$TMP_NMAP" "$TMP_NETDISCOVER" "$TMP_NBTSCAN"; echo -e "\n Interrupted! Exiting..."; exit 1' INT HUP TERM

	# Run scanners and redirect output to temp files

	echo "-> Running nmap..."
	# -sn for ping scan, -oG for grepable output
	sudo nmap -sn -oG "$TMP_NMAP" "$__NETIFACE_IPADDR_SCAN_RANGE" >/dev/null 2>&1
	echo -e "NMAP SCAN RESULTS:\n"
	cat "$TMP_NMAP"
	echo -e "\n\e[3;102m ========================================= \e[0m"

	echo "-> Running netdiscover..."
	# -P for parseable output, -N to hide headers
	sudo netdiscover -r "$__NETIFACE_IPADDR_SCAN_RANGE" -i "$__SELECTED_NETIFACE_FINAL" -P -N -c 3 -s 50 >"$TMP_NETDISCOVER"
	echo "NETDISCOVER SCAN RESULTS:"
	cat "$TMP_NETDISCOVER"

	echo -e "\n\e[3;102m ========================================= \e[0m"

	echo -e "\e[4;43m" "-> Running nbtscan to obtain HOSTnames / NetBIOS names [RANGE: $__NETIFACE_IPADDR_SCAN_RANGE]" "\e[0m"
	# -q to suppress headers for easier parsing
	sudo nbtscan -q "$__NETIFACE_IPADDR_SCAN_RANGE" >"$TMP_NBTSCAN"
	echo "NBTSCAN SCAN RESULTS:"
	cat "$TMP_NBTSCAN"

	echo -e "\n\e[3;102m ========================================= \e[0m"

	echo -e "\nScan complete for network range: $__NETIFACE_IPADDR_SCAN_RANGE" ["$__SELECTED_NETIFACE_FINAL"]

	echo -ne "\n##################################################################################"

	# --- Cleanup ---
	# Remove temporary files
	rm -f "$TMP_NMAP" "$TMP_NETDISCOVER" "$TMP_NBTSCAN"
	# Reset trap to default behavior
	trap - INT HUP TERM

	# Wait for user input before returning to the menu.
	echo ""
	read -r -s -p "Press ENTER to return to the main menu..."
}

show_help() {
	whiptail --backtitle "SCAN NETWORK IP ADDRESSES" --title "Help / About" --msgbox \
		"This script is designed to scan your local network to discover connected devices.

**Functionality:**
1.  **Dependency Check:** Automatically checks for and installs required tools (nmap, netdiscover, whiptail).
2.  **Interface Selection:** Prompts you to select a network interface to scan.
3.  **Network Scanning:** Uses a combination of nmap, netdiscover, and nbtscan to find live hosts, IP addresses, and NetBIOS names.
4.  **Results Display:** Shows the output from all scanners.

**Dependencies:**
- nmap
- netdiscover
- whiptail
- sudo (for administrative privileges)

The script will loop back to the main menu after each scan." 0 0
}

while true; do
	CHOICE=$(whiptail --backtitle "SCAN NETWORK IP ADDRESSES" --title "Main Menu" --menu "Choose an option:" 0 0 3 \
		"1" "Scan Network" \
		"2" "Help / About" \
		"3" "Exit" 3>&1 1>&2 2>&3)

	case $CHOICE in
	1)
		FUN_NETWORKING_SCAN_NETWORK
		;;
	2)
		show_help
		;;
	3)
		echo "Exiting."
		exit 0
		;;
	*)
		echo "Exiting."
		exit 0
		;;
	esac
done
